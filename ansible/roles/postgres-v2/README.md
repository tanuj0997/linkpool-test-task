# Tags Available

### - `selinux`
Install SELinux packages.
Works for primary and replicas.


### - `install_postgres`
Install postgres from packages, create directories and run it at the end.
Works for primary and replicas.

### - `extensions`
Install the extensions.

### - `config`
Will apply configuration changes and notify to restart or reload.
Default is reload. To restart pass `-e postgres_force_restart=true`
Works for primary and replicas.

### - `slots`
Creates replication slots on Primary.

### - `users_and_permissions`
Setup users and permissions.
WIll create users and GRANT/REVOKE some permissions from each.

### - `sftp`
Same as `users_and_permissions` but only for SFT user.

### - `setup_replica`
Will ERASE current replica database and recover it from a base backup. Users the recovery.conf file.
YOu may want to execute this if making changes to replications slots.
Works for replicas only.

### - `always` This is a special tag to always run the task. Used only when calling `include_tasks` or `include_vars`

## Example:

1 - Changing config on master only
```
$ ansible-playbook -i deployment/inventories/development/postgres -b postgres-v2.yml --vault-password-file .ansible-password-development  --limit 192.168.50.101 -t config

PLAY [postgres] *******************************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] ************************************************************************************************************************************************************************************************************************************
ok: [192.168.50.101]

TASK [postgres-v2 : include vars] *************************************************************************************************************************************************************************************************************************
ok: [192.168.50.101]

TASK [postgres-v2 : upload env specific conf] *************************************************************************************************************************************************************************************************************
changed: [192.168.50.101] => (item=postgresql.conf)
ok: [192.168.50.101] => (item=pg_hba.conf)

TASK [postgres-v2 : setup primary and replica] ************************************************************************************************************************************************************************************************************
included: /Users/raivil/linkpool/ansible/roles/postgres-v2/tasks/primary.yml for 192.168.50.101

RUNNING HANDLER [postgres-v2 : restart postgresql] ********************************************************************************************************************************************************************************************************
skipping: [192.168.50.101]

RUNNING HANDLER [postgres-v2 : reload postgresql] *********************************************************************************************************************************************************************************************************
changed: [192.168.50.101]

PLAY RECAP ************************************************************************************************************************************************************************************************************************************************
192.168.50.101             : ok=10   changed=4    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
 ```

2 - Rebuilding the replica

```
$ ansible-playbook -i deployment/inventories/development/postgres -b postgres-v2.yml --vault-password-file .ansible-password-development  --limit 192.168.50.102 -t setup_replica

PLAY [postgres] *******************************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] ************************************************************************************************************************************************************************************************************************************
ok: [192.168.50.102]

TASK [postgres-v2 : include vars] *************************************************************************************************************************************************************************************************************************
ok: [192.168.50.102]

TASK [postgres-v2 : setup primary and replica] ************************************************************************************************************************************************************************************************************
included: /Users/raivil/linkpool/ansible/roles/postgres-v2/tasks/replica.yml for 192.168.50.102

TASK [postgres-v2 : stop postgres for restore] ************************************************************************************************************************************************************************************************************
ok: [192.168.50.102]

TASK [postgres-v2 : delete stale data] ********************************************************************************************************************************************************************************************************************
changed: [192.168.50.102]

TASK [postgres-v2 : upload pgpass] ************************************************************************************************************************************************************************************************************************
ok: [192.168.50.102]

TASK [postgres-v2 : get base backup] **********************************************************************************************************************************************************************************************************************
changed: [192.168.50.102]

TASK [postgres-v2 : upload recovery.conf] *****************************************************************************************************************************************************************************************************************
changed: [192.168.50.102]

TASK [postgres-v2 : upload env specific conf] *************************************************************************************************************************************************************************************************************
changed: [192.168.50.102] => (item=postgresql.conf)
changed: [192.168.50.102] => (item=pg_hba.conf)

TASK [postgres-v2 : Ensure PostgreSQL is running] *********************************************************************************************************************************************************************************************************
changed: [192.168.50.102]

PLAY RECAP ************************************************************************************************************************************************************************************************************************************************
192.168.50.102             : ok=10   changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

3 - Applying users and permissions to the primary instance

```
$ ansible-playbook -i deployment/inventories/development/postgres -b postgres-v2.yml --vault-password-file .ansible-password-development  --limit 192.168.50.101 -t users_and_permissions

PLAY [postgres] *******************************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] ************************************************************************************************************************************************************************************************************************************
ok: [192.168.50.101]

TASK [postgres-v2 : include vars] *************************************************************************************************************************************************************************************************************************
ok: [192.168.50.101]

TASK [postgres-v2 : setup primary and replica] ************************************************************************************************************************************************************************************************************
included: /Users/raivil/linkpool/ansible/roles/postgres-v2/tasks/primary.yml for 192.168.50.101

TASK [postgres-v2 : create stackdriver user] **************************************************************************************************************************************************************************************************************
ok: [192.168.50.101]

TASK [postgres-v2 : create barman user for streaming] *****************************************************************************************************************************************************************************************************
ok: [192.168.50.101]

TASK [postgres-v2 : create barman user] *******************************************************************************************************************************************************************************************************************
ok: [192.168.50.101]

TASK [postgres-v2 : create pgpool user] *******************************************************************************************************************************************************************************************************************
ok: [192.168.50.101]

TASK [postgres-v2 : create barman db] *********************************************************************************************************************************************************************************************************************
ok: [192.168.50.101]

TASK [postgres-v2 : create sftp user] *********************************************************************************************************************************************************************************************************************
ok: [192.168.50.101]

TASK [postgres-v2 : create app user] **********************************************************************************************************************************************************************************************************************
ok: [192.168.50.101]

TASK [postgres-v2 : create linkpool_development db] ****************************************************************************************************************************************************************************************************
ok: [192.168.50.101]

TASK [postgres-v2 : grant permissions to core_app] ********************************************************************************************************************************************************************************************************
changed: [192.168.50.101] => (item=table)
ok: [192.168.50.101] => (item=sequence)

TASK [postgres-v2 : grant all on schema] ******************************************************************************************************************************************************************************************************************
ok: [192.168.50.101]

TASK [postgres-v2 : revoke truncate on public schema] *****************************************************************************************************************************************************************************************************
changed: [192.168.50.101]

TASK [postgres-v2 : ALTER DEFAULT PRIVILEGES FOR ROLE core_app REVOKE truncate ON TABLES FROM core_app;] **************************************************************************************************************************************************
changed: [192.168.50.101]

TASK [postgres-v2 : revoke truncate on all tables] ********************************************************************************************************************************************************************************************************
ok: [192.168.50.101]

TASK [postgres-v2 : update app user] **********************************************************************************************************************************************************************************************************************
changed: [192.168.50.101]

TASK [postgres-v2 : create core_app_db_migrations user] ***************************************************************************************************************************************************************************************************
ok: [192.168.50.101]

TASK [postgres-v2 : grant permissions to core_app_db_migrations on core_app database] *********************************************************************************************************************************************************************
ok: [192.168.50.101] => (item=table)
ok: [192.168.50.101] => (item=sequence)

TASK [postgres-v2 : grant all on public schema to core_app_db_migrations] *********************************************************************************************************************************************************************************
ok: [192.168.50.101]

PLAY RECAP ************************************************************************************************************************************************************************************************************************************************
192.168.50.101             : ok=20   changed=4    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```
